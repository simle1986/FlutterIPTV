name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  FLUTTER_VERSION: '3.16.9'

jobs:
  # ============================================
  # Build Windows Application
  # ============================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Enable Windows Desktop Support
        run: flutter config --enable-windows-desktop
      
      - name: Install NSIS
        run: |
          # Install NSIS using chocolatey
          choco install nsis -y
        shell: pwsh
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Set GitHub Token Environment Variable
        run: |
          Write-Host "Setting GITHUB_TOKEN environment variable for build"
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $env:GITHUB_ENV
        shell: pwsh
      
      - name: Build Windows Release
        run: flutter build windows --release --dart-define=GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
      
      - name: Download SQLite3 DLL
        run: |
          # Try to download SQLite3 DLL from official source
          # SQLite version format: 3.51.1 = 3510100
          $success = $false
          
          # Try sqlite.org first (2025 directory for latest versions)
          $urls = @(
            "https://www.sqlite.org/2025/sqlite-dll-win-x64-3510100.zip",
            "https://www.sqlite.org/2024/sqlite-dll-win-x64-3470200.zip",
            "https://www.sqlite.org/2024/sqlite-dll-win-x64-3460100.zip"
          )
          
          foreach ($url in $urls) {
            try {
              Write-Host "Trying: $url"
              Invoke-WebRequest -Uri $url -OutFile "sqlite3.zip" -TimeoutSec 30
              if (Test-Path "sqlite3.zip") {
                Expand-Archive -Path "sqlite3.zip" -DestinationPath "sqlite3_temp" -Force
                if (Test-Path "sqlite3_temp/sqlite3.dll") {
                  Copy-Item -Path "sqlite3_temp/sqlite3.dll" -Destination "build/windows/x64/runner/Release/" -Force
                  Write-Host "Successfully downloaded sqlite3.dll from: $url"
                  $success = $true
                  break
                }
              }
            } catch {
              Write-Host "Failed to download from: $url - $_"
              continue
            }
          }
          
          if (-not $success) {
            Write-Error "Failed to download sqlite3.dll from any source!"
            exit 1
          }
        shell: pwsh
      
      - name: Create Windows Distribution Package
        run: |
          # Create distribution folder
          New-Item -ItemType Directory -Force -Path "dist/windows"
          
          # Copy the entire Release folder contents (includes all DLLs and data folder)
          Copy-Item -Path "build/windows/x64/runner/Release/*" -Destination "dist/windows/" -Recurse -Force
          
          # Verify critical files exist
          if (!(Test-Path "dist/windows/flutter_iptv.exe")) {
            Write-Error "flutter_iptv.exe not found!"
            exit 1
          }
          if (!(Test-Path "dist/windows/flutter_windows.dll")) {
            Write-Error "flutter_windows.dll not found!"
            exit 1
          }
          if (!(Test-Path "dist/windows/data")) {
            Write-Error "data folder not found!"
            exit 1
          }
          if (!(Test-Path "dist/windows/sqlite3.dll")) {
            Write-Error "sqlite3.dll not found!"
            exit 1
          }
          
          # List contents for debugging
          Write-Host "Windows package contents:"
          Get-ChildItem -Path "dist/windows/" -Recurse | ForEach-Object { Write-Host $_.FullName }
          
          # Create ZIP archive for portable version
          Compress-Archive -Path "dist/windows/*" -DestinationPath "flutteriptv-Windows-x64.zip" -Force
          
          # Create NSIS installer
          Write-Host "Creating NSIS installer..."
          
          # Create NSIS script
          $nsisScript = @"
          !define APPNAME "FlutterIPTV"
          !define VERSION "1.1.15"
          !define PUBLISHER "FlutterIPTV"
          !define URL "https://github.com/shnulaa/FlutterIPTV"
          !define EXECUTABLE "flutter_iptv.exe"
          
          # Modern UI
          !include "MUI2.nsh"
          
          # General
          Name "\${APPNAME}"
          OutFile "flutteriptv-Windows-x64-Setup.exe"
          InstallDir "\$PROGRAMFILES64\\${APPNAME}"
          InstallDirRegKey HKLM "Software\\${APPNAME}" "InstallPath"
          RequestExecutionLevel admin
          
          # Interface Settings
          !define MUI_ABORTWARNING
          !define MUI_ICON "assets\\icons\\app_icon.ico"
          !define MUI_UNICON "assets\\icons\\app_icon.ico"
          
          # Pages
          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_LICENSE "LICENSE"
          !insertmacro MUI_PAGE_COMPONENTS
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH
          
          !insertmacro MUI_UNPAGE_WELCOME
          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES
          !insertmacro MUI_UNPAGE_FINISH
          
          # Languages
          !insertmacro MUI_LANGUAGE "English"
          !insertmacro MUI_LANGUAGE "SimpChinese"
          
          # Installer Sections
          Section "Main Section" SecMain
            SetOutPath "\$INSTDIR"
            File /r "dist\\windows\\*"
            
            # Create shortcuts
            CreateDirectory "\$SMPROGRAMS\\${APPNAME}"
            CreateShortCut "\$SMPROGRAMS\\${APPNAME}\\${APPNAME}.lnk" "\$INSTDIR\\${EXECUTABLE}"
            CreateShortCut "\$DESKTOP\\${APPNAME}.lnk" "\$INSTDIR\\${EXECUTABLE}"
            
            # Registry information for add/remove programs
            WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${APPNAME}" "DisplayName" "\${APPNAME}"
            WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${APPNAME}" "UninstallString" "\$INSTDIR\\uninstall.exe"
            WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${APPNAME}" "DisplayVersion" "\${VERSION}"
            WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${APPNAME}" "Publisher" "\${PUBLISHER}"
            WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${APPNAME}" "URLInfoAbout" "\${URL}"
            WriteRegDWORD HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${APPNAME}" "NoModify" 1
            WriteRegDWORD HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${APPNAME}" "NoRepair" 1
            
            # Create uninstaller
            WriteUninstaller "\$INSTDIR\\uninstall.exe"
          SectionEnd
          
          # Uninstaller Section
          Section "Uninstall"
            # Remove shortcuts
            Delete "\$SMPROGRAMS\\${APPNAME}\\${APPNAME}.lnk"
            Delete "\$DESKTOP\\${APPNAME}.lnk"
            RMDir "\$SMPROGRAMS\\${APPNAME}"
            
            # Remove files and directories
            RMDir /r "\$INSTDIR"
            
            # Remove registry keys
            DeleteRegKey HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${APPNAME}"
            DeleteRegKey HKLM "Software\\${APPNAME}"
          SectionEnd
          "@
          
          # Save NSIS script
          Set-Content -Path "installer.nsi" -Value $nsisScript
          
          # Find NSIS installation (chocolatey installs to C:\ProgramData\chocolatey\bin\makensis.exe)
          $nsisPath = ""
          $possiblePaths = @(
            "C:\ProgramData\chocolatey\bin\makensis.exe",
            "C:\Program Files (x86)\NSIS\makensis.exe",
            "C:\Program Files\NSIS\makensis.exe"
          )
          
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              $nsisPath = $path
              break
            }
          }
          
          if ($nsisPath) {
            Write-Host "Found NSIS at: $nsisPath"
            & $nsisPath "installer.nsi"
            if (Test-Path "flutteriptv-Windows-x64-Setup.exe") {
              Write-Host "NSIS installer created successfully!"
              # Verify installer size
              $installerSize = (Get-Item "flutteriptv-Windows-x64-Setup.exe").Length
              Write-Host "Installer size: $installerSize bytes"
            } else {
              Write-Error "NSIS installer creation failed!"
              exit 1
            }
          } else {
            Write-Error "NSIS not found! Please ensure NSIS is installed."
            exit 1
          }
        shell: pwsh
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            flutteriptv-Windows-x64.zip
            flutteriptv-Windows-x64-Setup.exe
          retention-days: 5

  # ============================================
  # Build Android Mobile APK
  # ============================================
  build-android-mobile:
    name: Build Android Mobile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Set GitHub Token Environment Variable
        run: |
          echo "Setting GITHUB_TOKEN environment variable for build"
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
        shell: bash
      
      - name: Build Android APK (Split by ABI)
        run: flutter build apk --release --split-per-abi --dart-define=GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
      
      - name: Rename APKs for Mobile
        run: |
          mkdir -p dist/android-mobile
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/android-mobile/flutteriptv-Android-Mobile-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/android-mobile/flutteriptv-Android-Mobile-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/android-mobile/flutteriptv-Android-Mobile-x86_64.apk
      
      - name: Build Universal APK
        run: flutter build apk --release --dart-define=GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
      
      - name: Copy Universal APK
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk dist/android-mobile/flutteriptv-Android-Mobile-universal.apk
      
      - name: Upload Android Mobile Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-mobile-release
          path: dist/android-mobile/
          retention-days: 5

  # ============================================
  # Build Android TV APK
  # ============================================
  build-android-tv:
    name: Build Android TV
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Set GitHub Token Environment Variable
        run: |
          echo "Setting GITHUB_TOKEN environment variable for build"
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
        shell: bash
      
      - name: Build Android TV APK
        run: |
          # Build with TV flag enabled
          flutter build apk --release --dart-define=IS_TV=true --dart-define=GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} --split-per-abi
      
      - name: Rename APKs for TV
        run: |
          mkdir -p dist/android-tv
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/android-tv/flutteriptv-AndroidTV-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/android-tv/flutteriptv-AndroidTV-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/android-tv/flutteriptv-AndroidTV-x86_64.apk
      
      - name: Build Universal TV APK
        run: flutter build apk --release --dart-define=IS_TV=true --dart-define=GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
      
      - name: Copy Universal TV APK
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk dist/android-tv/flutteriptv-AndroidTV-universal.apk
      
      - name: Upload Android TV Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-tv-release
          path: dist/android-tv/
          retention-days: 5

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    needs: [build-windows, build-android-mobile, build-android-tv]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: ./release-assets/
      
      - name: Download Android Mobile Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-mobile-release
          path: ./release-assets/android-mobile/
      
      - name: Download Android TV Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-tv-release
          path: ./release-assets/android-tv/
      
      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "TAG=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Release Notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## ðŸ“º flutteriptv ${{ steps.version.outputs.VERSION }}
          
          ### ðŸ“¥ Downloads
          
          #### Windows
          | File | Description |
          |------|-------------|
          | `flutteriptv-Windows-x64-Setup.exe` | Windows 64-bit installer (recommended) |
          | `flutteriptv-Windows-x64-Setup.bat` | Windows 64-bit installer (alternative) |
          | `flutteriptv-Windows-x64.zip` | Windows 64-bit portable application |
          
          #### Android Mobile
          | File | Description |
          |------|-------------|
          | `flutteriptv-Android-Mobile-arm64-v8a.apk` | 64-bit ARM devices (recommended for most modern phones) |
          | `flutteriptv-Android-Mobile-armeabi-v7a.apk` | 32-bit ARM devices (older phones) |
          | `flutteriptv-Android-Mobile-x86_64.apk` | x86_64 emulators |
          | `flutteriptv-Android-Mobile-universal.apk` | Universal (larger file, works on all devices) |
          
          #### Android TV
          | File | Description |
          |------|-------------|
          | `flutteriptv-AndroidTV-arm64-v8a.apk` | 64-bit ARM TV devices (Fire TV Stick 4K, Shield TV, etc.) |
          | `flutteriptv-AndroidTV-armeabi-v7a.apk` | 32-bit ARM TV devices (older Fire TV) |
          | `flutteriptv-AndroidTV-x86_64.apk` | x86_64 TV emulators |
          | `flutteriptv-AndroidTV-universal.apk` | Universal TV (larger file, works on all TV devices) |
          
          ### âœ¨ Features
          - M3U/M3U8 playlist support
          - High-quality video playback (HLS, DASH, RTMP)
          - Channel grouping and favorites
          - Full D-Pad navigation for Android TV
          - Dark theme optimized for TV viewing
          
          ### ðŸ“‹ Installation
          
          **Windows:**
          1. Download `flutteriptv-Windows-x64-Setup.exe` (installer) or `flutteriptv-Windows-x64.zip` (portable)
          2. For installer: Run the exe and follow the installation wizard
           For portable: Extract the zip and run `flutter_iptv.exe`
          
          **Android Mobile:**
          1. Download the appropriate APK for your device
          2. Enable "Install from unknown sources" if prompted
          3. Install and open the app
          
          **Android TV:**
          1. Download the appropriate APK for your TV
          2. Install via USB, ADB, or file manager app
          3. Launch from the TV app drawer
          
          ---
          
          > ðŸ’¡ **Tip:** For ARM64 devices, use the `arm64-v8a` version for better performance.
          EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: flutteriptv ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-assets/flutteriptv-Windows-x64.zip
            release-assets/flutteriptv-Windows-x64-Setup.exe
            release-assets/flutteriptv-Windows-x64-Setup.bat
            release-assets/android-mobile/flutteriptv-Android-Mobile-arm64-v8a.apk
            release-assets/android-mobile/flutteriptv-Android-Mobile-armeabi-v7a.apk
            release-assets/android-mobile/flutteriptv-Android-Mobile-x86_64.apk
            release-assets/android-mobile/flutteriptv-Android-Mobile-universal.apk
            release-assets/android-tv/flutteriptv-AndroidTV-arm64-v8a.apk
            release-assets/android-tv/flutteriptv-AndroidTV-armeabi-v7a.apk
            release-assets/android-tv/flutteriptv-AndroidTV-x86_64.apk
            release-assets/android-tv/flutteriptv-AndroidTV-universal.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
